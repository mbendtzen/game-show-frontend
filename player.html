<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get in the Game Show - PLAYER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

      body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #455cd2 0%, #3b4dbf 30%, #2d3ea6 60%, #1e2f8d 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        #sparkles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  overflow: hidden;
}

/* --- SHARP DIAMOND SPARKLES --- */
.sparkle { 
  position:absolute; 
  will-change: transform, opacity; 
  pointer-events:none; 
}
.sparkle::before {
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(45deg, transparent 45%, rgba(255,255,255,.95) 50%, transparent 55%),
    linear-gradient(-45deg, transparent 45%, rgba(255,255,255,.95) 50%, transparent 55%);
  filter: drop-shadow(0 0 3px rgba(255,255,255,.6));
}
@keyframes sparkle-pop {
  0%   { opacity:0; transform: scale(.4) rotate(0deg); }
  50%  { opacity:1; transform: scale(1.2) rotate(45deg); }
  100% { opacity:0; transform: scale(.9) rotate(90deg); }
}

/* --- SPOTLIGHTS WITH TAPERED RAYS --- */
.spotlight { 
  position:absolute; 
  will-change: transform, opacity; 
  pointer-events:none; 
}
.spotlight .core {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width: 14px; height: 14px; border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 80%);
  filter: drop-shadow(0 0 10px rgba(255,255,255,.6));
}
.spotlight .ray {
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  background: radial-gradient(ellipse at center, rgba(255,255,255,.8) 0%, rgba(255,255,255,.4) 30%, rgba(255,255,255,0) 100%);
  transform-origin:center;
}
.spotlight .ray.h {
  width: 200px; height: 6px;
}
.spotlight .ray.v {
  width: 6px; height: 200px;
}
@keyframes spot-flash {
  0%   { opacity:0; transform: scale(.7); }
  60%  { opacity:1; transform: scale(1.05); }
  100% { opacity:0; transform: scale(.9); }
}


        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            background: linear-gradient(45deg, #FFEB3B 0%, #FFD700 25%, #FFC107 50%, #FFB300 75%, #FFEB3B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
            background-size: 200% 200%;
            animation: goldShine 3s ease-in-out infinite;
        }

        @keyframes goldShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* UPDATED FREQUENT FUN BUTTON - Sharp white border shimmer */
        .frequent-fun-premium {
            position: relative;
            overflow: hidden;
        }

 .frequent-fun-premium::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 200%;
  height: 100%;
  background: linear-gradient(120deg, transparent, #fff, transparent);
  border-radius: 18px;
  animation: borderShimmer 2s linear infinite;
  z-index: -1;
}

        @keyframes button-shimmer {
            0% { 
                background-position: 0% 50%;
                box-shadow: 
                    0 0 20px rgba(255,255,255,0.3),
                    inset 0 0 20px rgba(255,255,255,0.1);
            }
            50% { 
                background-position: 100% 50%;
                box-shadow: 
                    0 0 30px rgba(255,255,255,0.8),
                    inset 0 0 30px rgba(255,255,255,0.3);
            }
            100% { 
                background-position: 0% 50%;
                box-shadow: 
                    0 0 20px rgba(255,255,255,0.3),
                    inset 0 0 20px rgba(255,255,255,0.1);
            }
        }

        @keyframes borderShimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

        @keyframes sparkle-float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.8; }
            50% { transform: translateY(-3px) rotate(180deg); opacity: 1; }
        }
        
        .card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .input-field::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .input-field:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.5s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8B5CF6, #EC4899);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #10B981, #34D399);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #F59E0B, #FBBF24);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-team-change {
            background: linear-gradient(45deg, #a936f6, #9933d6);
            color: white;
            box-shadow: 0 4px 15px rgba(117, 0, 195, 0.4);
        }

        .btn-exit {
            background: linear-gradient(45deg, #a936f6, #9933d6);
            color: white;
            box-shadow: 0 4px 15px rgba(248, 18, 142, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-3px);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-row .btn {
            margin-bottom: 0;
        }

        /* BUZZER STYLES - Enhanced 3D Design */
        .buzzer-container {
            text-align: center;
            margin: 30px 0;
        }

        .buzzer {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            border: none;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 auto;
            display: block;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            line-height: 1.3;
            /* 3D Effect */
            box-shadow: 
                0 0 0 8px rgba(255,255,255,0.1),
                0 0 0 16px rgba(255,255,255,0.05),
                0 20px 40px rgba(0,0,0,0.4),
                inset 0 -10px 20px rgba(0,0,0,0.2);
        }

        .buzzer.ready {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            color: #000;
            box-shadow: 
                0 0 0 8px rgba(255,215,0,0.3),
                0 0 0 16px rgba(255,215,0,0.1),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 25px 50px rgba(0,0,0,0.4),
                inset 0 -15px 30px rgba(0,0,0,0.3),
                inset 0 5px 20px rgba(255,255,255,0.4);
            animation: buzzer-pulse 2s infinite;
        }

        .buzzer.buzzed-in {
            background: linear-gradient(135deg, #10B981 0%, #34D399 50%, #6EE7B7 100%);
            color: white;
            box-shadow: 
                0 0 0 8px rgba(16,185,129,0.3),
                0 0 0 16px rgba(16,185,129,0.1),
                0 0 40px rgba(16, 185, 129, 0.8),
                0 25px 50px rgba(0,0,0,0.4),
                inset 0 -15px 30px rgba(0,0,0,0.3),
                inset 0 5px 20px rgba(255,255,255,0.3);
            animation: none;
        }

        .buzzer.locked-out {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 50%, #FCA5A5 100%);
            color: white;
            box-shadow: 
                0 0 0 8px rgba(239,68,68,0.3),
                0 0 0 16px rgba(239,68,68,0.1),
                0 0 40px rgba(239, 68, 68, 0.8),
                0 25px 50px rgba(0,0,0,0.4),
                inset 0 -15px 30px rgba(0,0,0,0.3),
                inset 0 5px 20px rgba(255,255,255,0.2);
            animation: none;
        }

        .buzzer:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .buzzer:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 
                0 0 0 8px rgba(255,255,255,0.1),
                0 0 0 16px rgba(255,255,255,0.05),
                0 10px 20px rgba(0,0,0,0.4),
                inset 0 -5px 15px rgba(0,0,0,0.3);
        }

        @keyframes buzzer-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .player-info {
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #d946ef 0%, #c026d3 50%, #a21caf 100%);
            border: 3px solid #FFD700;
            border-radius: 12px;
            color: #FFD700;
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.4),
                0 8px 16px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .game-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
            flex-direction: row;
        }

        .score-entry {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .score-entry label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #FFD700;
        }

        .score-input {
            width: 80px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.9);
            color: #000;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
            margin-left: 0;
            flex: 1;
            max-width: 120px;
        }

        .frequent-fun {
            text-align: center;
        }

        .frequent-fun .btn {
            font-size: 14px;
            padding: 10px 20px;
        }

        .frequent-fun .btn {
            background: linear-gradient(45deg, #ac5ef8, #8b4fd1) !important;
            box-shadow: 0 4px 15px rgba(172, 94, 248, 0.4) !important;
        }
        
        .dropdown {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .dropdown option {
            background: #333;
            color: white;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #10B981;
            color: white;
        }

        .disconnected {
            background: #EF4444;
            color: white;
        }

        /* Final Results Styles */
        .final-results {
            text-align: center;
            padding: 30px 20px;
        }

        .points-announcement {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
            animation: celebrate 2s ease-in-out infinite;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .placement-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .place-1st { color: #FFD700; }
        .place-2nd { color: #C0C0C0; }
        .place-3rd { color: #CD7F32; }
        .place-other { color: #FFF; }

        .final-cta {
            margin-top: 25px;
        }

        .final-cta p {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.8;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .buzzer {
                width: 220px;
                height: 220px;
                font-size: 1.2rem;
            }

            .player-info {
                font-size: 1.1rem;
            }

            .game-controls {
                flex-direction: column;
                align-items: center;
            }

            .control-buttons {
                flex-direction: column;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Sparkles Background -->
    <div id="sparkles"></div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting...
    </div>

    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Game Show Logo" style="max-height: 120px; width: auto; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">
            <h1>PLAYER DASHBOARD</h1>
        </div>

        <!-- Step 1: Game Code Entry -->
        <div id="gameCodeEntry" class="card">
            <input type="text" class="input-field" id="gameCodeInput" placeholder="Enter 6-digit game code" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 2px;">
            <button class="btn btn-warning" onclick="joinGame()">‚≠êÔ∏è JOIN GAME ‚≠êÔ∏è</button>
        </div>

        <!-- Step 2: Player Setup -->
        <div id="playerSetup" class="card hidden">
            <input type="text" class="input-field" id="playerName" placeholder="Enter your name (40 chars max)" maxlength="40">
            <div id="teamOptions" class="btn-row hidden">
                <button class="btn btn-primary" onclick="createTeam()">CREATE TEAM</button>
                <button class="btn btn-success" onclick="showJoinTeam()">JOIN TEAM</button>
            </div>

            <div id="teamCreation" class="hidden" style="margin-top: 20px;">
                <input type="text" class="input-field" id="teamName" placeholder="Enter team name (60 chars max)" maxlength="60">
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="submitTeam()">SUBMIT üí´</button>
                    <button class="btn btn-warning" onclick="goBackToTeamChoice()">GO BACK</button>
                </div>
            </div>

            <div id="teamJoining" class="hidden" style="margin-top: 20px;">
                <select class="dropdown" id="teamSelect">
                    <option value="">Select a team to join</option>
                </select>
                <div class="btn-row">
                    <button class="btn btn-success" onclick="joinSelectedTeam()">LET'S PLAY! ‚ú®</button>
                    <button class="btn btn-warning" onclick="goBackToTeamChoice()">GO BACK</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Player Game View -->
        <div id="playerGameView" class="hidden">
            <div class="player-info" id="playerInfo">
                Player Name | Team Name<br>
                Game 1: Round 1
            </div>

            <div class="btn-row">
                <button class="btn btn-team-change btn-small" onclick="changeTeam()">CHG TEAM</button>
                <button class="btn btn-exit btn-small" onclick="leaveGame()">EXIT</button>
            </div>

            <div class="buzzer-container">
                <button class="buzzer ready" id="playerBuzzer" onclick="playerBuzz()">
                    Get ready to<br>Get in the Game!
                </button>
            </div>

            <div class="game-controls">
                <div id="scoreEntry" class="score-entry hidden">
                    <label id="scoreLabel">Enter Score:</label>
                    <input type="number" id="scoreInput" class="score-input" placeholder="0" min="0" max="9999">
                    <button class="btn btn-success btn-small" onclick="submitScore()">Submit</button>
                </div>

                <div class="frequent-fun">
                    <button class="btn btn-primary frequent-fun-premium" onclick="joinFrequentFun()">
                        üíé Join Frequent Fun Program üíé
                    </button>
                </div>
            </div>

            <!-- Final Results -->
            <div id="finalResults" class="card hidden">
                <div class="final-results">
                    <div id="playerPlacement" class="placement-display"></div>
                    
                    <div class="points-announcement">
                        üéâ <span style="color: #00CED1; text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,206,209,0.6);">You Just Earned 1000 Frequent Flier sMiles!</span> üòÉ
                    </div>

                    <div class="final-cta">
                        <button class="btn btn-primary" onclick="joinFrequentFun()">
                            üíé Join Now üíé It's Free!
                        </button>
                        <p>Earn cool rewards and prizes just for playing!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const FREQUENT_FUN_URL = 'https://pages.thedoctoroffun.com/join-frequent-fun-program-page';

        // WebSocket connection for real-time communication
        let ws = null;
        let playerState = {
            playerId: generateId(),
            name: '',
            teamName: '',
            isManager: false,
            buzzedIn: false,
            gameCode: '',
            connected: false
        };

        let gameState = {
            currentGame: 1,
            currentRound: 1,
            games: [],
            scoringEnabled: false,
            gameStarted: false,
            teams: {}
        };

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Initialize connection
        function initializeConnection() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = 'wss://game-show-backend.onrender.com';
            console.log('Connecting to:', wsUrl);
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    console.log('WebSocket connected');
                    updateConnectionStatus(true);
                };

                ws.onmessage = function(event) {
                    console.log('Received:', event.data);
                    handleMessage(event.data);
                };

                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);
                    setTimeout(initializeConnection, 2000);
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateConnectionStatus(false);
                setTimeout(initializeConnection, 2000);
            }
        }

        function updateConnectionStatus(connected) {
            playerState.connected = connected;
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'Connected';
                status.className = 'connection-status connected';
            } else {
                status.textContent = 'Reconnecting...';
                status.className = 'connection-status disconnected';
            }
        }

        // NEW SHARP SPARKLES CREATION FUNCTION
        function createSparkles() {
  const stage = document.getElementById('sparkles');
  const rand = (min, max) => Math.random() * (max - min) + min;

  function randomViewportPos(pad){
    const x = rand(pad, 100 - pad);
    const y = rand(pad, 100 - pad);
    return {x, y};
  }

  // --- SPARKLE (tiny diamond) ---
  function spawnSparkle(){
    const {x, y} = randomViewportPos(4);
    const size = rand(1, 6); // smaller, sharper
    const dur = rand(120, 300);
    const el = document.createElement('div');
    el.className = 'sparkle';
    el.style.left = x + 'vw';
    el.style.top  = y + 'vh';
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    el.style.animation = `sparkle-pop ${dur}ms ease-out 1 both`;
    stage.appendChild(el);
    el.addEventListener('animationend', () => el.remove(), {once:true});
  }

  // --- SPOTLIGHT (big cross flare) ---
  function spawnSpotlight(){
    const {x, y} = randomViewportPos(8);
    const dur = rand(200, 420);
    const size = rand(120, 260);
    const el = document.createElement('div');
    el.className = 'spotlight';
    el.style.left = x + 'vw';
    el.style.top  = y + 'vh';
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    el.style.marginLeft = `-${size/2}px`;
    el.style.marginTop  = `-${size/2}px`;
    el.style.animation = `spot-flash ${dur}ms ease-out 1 both`;

    const core = document.createElement('div');
    core.className = 'core';
    el.appendChild(core);

    const rayH = document.createElement('div');
    rayH.className = 'ray h';
    el.appendChild(rayH);

    const rayV = document.createElement('div');
    rayV.className = 'ray v';
    el.appendChild(rayV);

    stage.appendChild(el);
    el.addEventListener('animationend', () => el.remove(), {once:true});
  }

  // --- Schedule random events ---
  function scheduleRandom(fn, perSecond){
    const minGap = 8;
    let running = true;
    (function loop(){
      if(!running) return;
      const rate = perSecond();
      if(rate<=0){setTimeout(loop,120);return;}
      const interval = Math.max(minGap, -Math.log(1 - Math.random()) / rate * 1000);
      setTimeout(()=>{ if(!running) return; fn(); loop(); }, interval);
    })();
    return () => { running=false; };
  }

  // --- rates ---
  let sparklesPerSec = 6;
  let spotlightsPerMin = 30;

  scheduleRandom(spawnSparkle, () => sparklesPerSec);
  scheduleRandom(spawnSpotlight, () => spotlightsPerMin/60);

  for(let i=0;i<8;i++) setTimeout(spawnSparkle, i*60);
  for(let i=0;i<3;i++) setTimeout(spawnSpotlight, i*150);
}

        // Audio Functions
        function playBuzzerSound() {
            console.log('Trying to play buzzer sound...');
            try {
                const audio = new Audio('buzzer.mp3');
                audio.volume = 0.5;
                console.log('Audio object created, attempting to play...');
                audio.play().then(() => {
                    console.log('Audio played successfully!');
                }).catch(e => {
                    console.log('Audio play failed:', e);
                    console.log('Trying fallback buzzer...');
                    playFallbackBuzzer();
                });
            } catch (e) {
                console.log('Audio creation failed:', e);
                playFallbackBuzzer();
            }
        }

        function playFallbackBuzzer() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.5);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Fallback audio failed');
            }
        }

        // GAME FLOW FUNCTIONS
        function joinGame() {
            const gameCode = document.getElementById('gameCodeInput').value.trim();
            if (!gameCode || gameCode.length !== 6) {
                alert('Please enter a valid 6-digit game code!');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server. Please wait...');
                return;
            }

            playerState.gameCode = gameCode;

            // Check if game exists by attempting to join
            ws.send(JSON.stringify({
                type: 'CHECK_GAME',
                gameCode: gameCode
            }));

            // Show player setup
            document.getElementById('gameCodeEntry').classList.add('hidden');
            document.getElementById('playerSetup').classList.remove('hidden');
        }

        // Player name input handler
        document.addEventListener('DOMContentLoaded', function() {
            const playerNameInput = document.getElementById('playerName');
            const teamOptions = document.getElementById('teamOptions');

            playerNameInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    teamOptions.classList.remove('hidden');
                } else {
                    teamOptions.classList.add('hidden');
                    document.getElementById('teamCreation').classList.add('hidden');
                    document.getElementById('teamJoining').classList.add('hidden');
                }
            });
        });

        function createTeam() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name first!');
                return;
            }

            playerState.name = playerName;
            
            // Hide name input and team choice buttons
            document.getElementById('playerName').classList.add('hidden');
            document.getElementById('teamOptions').classList.add('hidden');
            
            // Show team creation form
            document.getElementById('teamCreation').classList.remove('hidden');
            document.getElementById('teamJoining').classList.add('hidden');
        }

        function showJoinTeam() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name first!');
                return;
            }

            playerState.name = playerName;
            
            // Hide name input and team choice buttons
            document.getElementById('playerName').classList.add('hidden');
            document.getElementById('teamOptions').classList.add('hidden');
            
            // Show team joining form
            requestTeamList();
            document.getElementById('teamJoining').classList.remove('hidden');
            document.getElementById('teamCreation').classList.add('hidden');
        }

        function requestTeamList() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server. Please wait...');
                return;
            }

            ws.send(JSON.stringify({
                type: 'GET_TEAMS',
                gameCode: playerState.gameCode
            }));
        }

        function updateTeamDropdown(teams) {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="">Select a team to join</option>';

            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.name;
                option.textContent = `${team.name} (${team.members} members)`;
                select.appendChild(option);
            });
        }

        function submitTeam() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Please enter a team name!');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server. Please wait...');
                return;
            }

            playerState.teamName = teamName;
            playerState.isManager = true;

            // Send join request to server
            ws.send(JSON.stringify({
                type: 'JOIN_GAME',
                playerId: playerState.playerId,
                playerName: playerState.name,
                teamName: playerState.teamName,
                gameCode: playerState.gameCode,
                isManager: playerState.isManager
            }));
        }

        function joinSelectedTeam() {
            const teamName = document.getElementById('teamSelect').value;
            if (!teamName) {
                alert('Please select a team!');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server. Please wait...');
                return;
            }

            playerState.teamName = teamName;
            playerState.isManager = false;

            // Send join request to server
            ws.send(JSON.stringify({
                type: 'JOIN_GAME',
                playerId: playerState.playerId,
                playerName: playerState.name,
                teamName: playerState.teamName,
                gameCode: playerState.gameCode,
                isManager: playerState.isManager
            }));
        }

        function updatePlayerGameInfo() {
            if (!gameState.gameStarted) {
                document.getElementById('playerInfo').innerHTML =
                    `${playerState.name} | ${playerState.teamName}<br>Waiting for host to start game...`;
                return;
            }

            const currentGameName = gameState.games[gameState.currentGame - 1] ?
                gameState.games[gameState.currentGame - 1][0] : 'Game';

            document.getElementById('playerInfo').innerHTML =
                `${playerState.name} | ${playerState.teamName}<br>Game ${gameState.currentGame}: ${currentGameName} - Round ${gameState.currentRound}`;

            // Show/hide score entry for managers with round info
            const scoreEntry = document.getElementById('scoreEntry');
            const scoreLabel = document.getElementById('scoreLabel');
            
            if (playerState.isManager && gameState.scoringEnabled) {
                scoreLabel.textContent = `Enter Score for Round ${gameState.currentRound}:`;
                scoreEntry.classList.remove('hidden');
            } else {
                scoreEntry.classList.add('hidden');
            }
        }

        // BUZZER FUNCTIONS
        function playerBuzz() {
            if (playerState.buzzedIn) return;

            if (!gameState.gameStarted) {
                alert('Game hasn\'t started yet!');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server!');
                return;
            }

            playBuzzerSound();

            // Send buzz to server
            ws.send(JSON.stringify({
                type: 'PLAYER_BUZZ',
                playerId: playerState.playerId,
                playerName: playerState.name,
                teamName: playerState.teamName,
                gameCode: playerState.gameCode,
                timestamp: Date.now()
            }));

            // Optimistically update UI (server will confirm)
            setBuzzerState('buzzed');
        }

        function setBuzzerState(state) {
            const buzzer = document.getElementById('playerBuzzer');
            buzzer.className = `buzzer ${state === 'buzzed' ? 'buzzed-in' : state === 'locked' ? 'locked-out' : 'ready'}`;

            switch(state) {
                case 'ready':
                    buzzer.innerHTML = 'Get ready to<br>Get in the Game!';
                    buzzer.disabled = false;
                    playerState.buzzedIn = false;
                    break;
                case 'buzzed':
                    buzzer.innerHTML = "üî• You're in! üî•<br>Wait for host to call on you!";
                    buzzer.disabled = true;
                    playerState.buzzedIn = true;
                    break;
                case 'locked':
                    buzzer.textContent = 'Your teammate beat you to it!';
                    buzzer.disabled = true;
                    break;
            }
        }

        function resetBuzzer() {
            setBuzzerState('ready');
        }

        // SCORING FUNCTIONS
        function submitScore() {
            if (!playerState.isManager) return;

            const scoreInput = document.getElementById('scoreInput');
            const score = parseInt(scoreInput.value) || 0;

            if (score < 0 || score > 9999) {
                alert('Please enter a score between 0 and 9999');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server!');
                return;
            }

            // Send score to server
            ws.send(JSON.stringify({
                type: 'SUBMIT_SCORE',
                playerId: playerState.playerId,
                teamName: playerState.teamName,
                gameCode: playerState.gameCode,
                score: score,
                game: gameState.currentGame,
                round: gameState.currentRound
            }));

            scoreInput.value = '';
            document.getElementById('scoreEntry').classList.add('hidden');
            gameState.scoringEnabled = false;

            alert('Score submitted successfully! üôå');
        }

        // NAVIGATION FUNCTIONS
        function changeTeam() {
            // Leave current team
            if (ws && ws.readyState === WebSocket.OPEN && playerState.teamName) {
                ws.send(JSON.stringify({
                    type: 'LEAVE_GAME',
                    playerId: playerState.playerId,
                    gameCode: playerState.gameCode
                }));
            }

            // Reset player state
            playerState.teamName = '';
            playerState.isManager = false;
            playerState.buzzedIn = false;

            // Show team selection again
            document.getElementById('playerGameView').classList.add('hidden');
            document.getElementById('playerSetup').classList.remove('hidden');
            
            // Reset and show setup form elements
            document.getElementById('playerName').style.display = 'block';
            document.getElementById('teamOptions').classList.remove('hidden');
            document.getElementById('teamCreation').classList.add('hidden');
            document.getElementById('teamJoining').classList.add('hidden');
        }
        
        function leaveGame() {
            if (confirm('Are you sure you want to leave the game?')) {
                // Leave game
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'LEAVE_GAME',
                        playerId: playerState.playerId,
                        gameCode: playerState.gameCode
                    }));
                }

                // Reset state
                playerState.gameCode = '';
                playerState.teamName = '';
                playerState.isManager = false;
                playerState.buzzedIn = false;

                // Return to game code entry
                document.getElementById('playerGameView').classList.add('hidden');
                document.getElementById('playerSetup').classList.add('hidden');
                document.getElementById('gameCodeEntry').classList.remove('hidden');
                
                // Clear inputs
                document.getElementById('gameCodeInput').value = '';
                document.getElementById('playerName').value = '';
            }
        }

        function joinFrequentFun() {
            window.open(FREQUENT_FUN_URL, '_blank');
        }

        // FINAL RESULTS FUNCTIONS
        function showFinalResults(placement, totalScore, isTied = false) {
            const placementDiv = document.getElementById('playerPlacement');
            let placeClass = 'place-other';
            if (placement === 1) placeClass = 'place-1st';
            else if (placement === 2) placeClass = 'place-2nd';
            else if (placement === 3) placeClass = 'place-3rd';

            const suffix = getOrdinalSuffix(placement);
            const tieText = isTied ? ' (Tie)' : '';

            placementDiv.innerHTML = `
                <div class="${placeClass}">
                    ${placement}${suffix} Place${tieText}!<br>
                    ${totalScore} points
                </div>
            `;

            // Hide buzzer and show results
            document.querySelector('.buzzer-container').style.display = 'none';
            document.querySelector('.frequent-fun').style.display = 'none';
            
            // Create confetti effect
            createConfetti();
            document.getElementById('finalResults').classList.remove('hidden');
        }

        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) return 'st';
            if (j == 2 && k != 12) return 'nd';
            if (j == 3 && k != 13) return 'rd';
            return 'th';
        }

        function createConfetti() {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1000;
            `;
            document.body.appendChild(celebration);

            const colors = ['#FFD700', '#FF69B4', '#00BFFF', '#32CD32', '#FF4500', '#9C27B0'];
            let confettiInterval;

            function createConfettiBurst() {
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.style.cssText = `
                            position: absolute;
                            width: ${Math.random() * 8 + 4}px;
                            height: ${Math.random() * 8 + 4}px;
                            background: ${colors[Math.floor(Math.random() * colors.length)]};
                            left: ${Math.random() * 100}vw;
                            top: -10px;
                            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                            animation: confetti-fall ${Math.random() * 3 + 2}s linear forwards;
                        `;
                        celebration.appendChild(confetti);
                        
                        // Remove confetti piece after animation
                        setTimeout(() => {
                            if (confetti.parentNode) {
                                confetti.parentNode.removeChild(confetti);
                            }
                        }, 5000);
                    }, i * 30);
                }
            }

            // Create initial burst
            createConfettiBurst();
            
            // Continue creating bursts every 1.5 seconds
            confettiInterval = setInterval(createConfettiBurst, 1500);

            // Add CSS animation if not already added
            if (!document.getElementById('confetti-style')) {
                const style = document.createElement('style');
                style.id = 'confetti-style';
                style.textContent = `
                    @keyframes confetti-fall {
                        to {
                            transform: translateY(100vh) rotate(720deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // Clean up after 30 seconds (or when user leaves)
            setTimeout(() => {
                clearInterval(confettiInterval);
                celebration.remove();
            }, 30000);

            // Store interval ID globally so it can be cleared if needed
            window.confettiInterval = confettiInterval;
        }

        // WEBSOCKET MESSAGE HANDLING
        function handleMessage(data) {
            const message = JSON.parse(data);
            console.log('Handling message:', message.type);

            switch(message.type) {
                case 'GAME_JOINED':
                    // Successfully joined game
                    gameState.gameStarted = message.gameStarted;
                    gameState.currentGame = message.currentGame;
                    gameState.currentRound = message.currentRound;
                    gameState.games = message.games;

                    // Switch to game view
                    document.getElementById('playerSetup').classList.add('hidden');
                    document.getElementById('playerGameView').classList.remove('hidden');
                    updatePlayerGameInfo();
                    break;

                case 'TEAMS_LIST':
                    updateTeamDropdown(message.teams);
                    break;

                            case 'NAME_CONFLICT': {
            const { playerName } = message;
            const modal = document.getElementById('nameConflictModal');
            const txt = document.getElementById('conflictText');
            txt.textContent = `There is already a player named "${playerName}" on this team.`;
            modal.classList.remove('hidden');

            document.getElementById('claimNameBtn').onclick = () => {
                modal.classList.add('hidden');
                ws.send(JSON.stringify({
                    type: 'CLAIM_NAME',
                    gameCode: playerState.gameCode,
                    teamName: playerState.teamName,
                    playerName: playerState.name
                }));
            };

            document.getElementById('renameBtn').onclick = () => {
                modal.classList.add('hidden');
                alert('Please enter a different name and try again.');
                document.getElementById('playerName').classList.remove('hidden');
                document.getElementById('teamOptions').classList.remove('hidden');
                document.getElementById('teamCreation').classList.add('hidden');
                document.getElementById('teamJoining').classList.add('hidden');
            };
            break;
        }

                case 'GAME_STARTED':
                    gameState.gameStarted = true;
                    gameState.games = message.games;
                    gameState.currentGame = message.currentGame;
                    gameState.currentRound = message.currentRound;
                    updatePlayerGameInfo();
                    break;

                case 'ROUND_UPDATE':
                    gameState.currentGame = message.currentGame;
                    gameState.currentRound = message.currentRound;
                    updatePlayerGameInfo();
                    break;

                case 'ENABLE_SCORING':
                    gameState.scoringEnabled = true;
                    updatePlayerGameInfo();
                    break;

                case 'CLEAR_BUZZERS':
                    resetBuzzer();
                    break;

                case 'BUZZ_RESPONSE':
                    // Server response to buzz attempt
                    if (message.playerId === playerState.playerId) {
                        if (message.success) {
                            setBuzzerState('buzzed');
                        } else {
                            if (message.reason === 'Teammate already buzzed' || message.reason.includes('teammate')) {
                                setBuzzerState('locked');
                            } else {
                                // Reset to ready if buzz failed for other reasons
                                setBuzzerState('ready');
                                alert(message.reason);
                            }
                        }
                    }
                    break;

                case 'MANAGER_CHANGED':
                    if (message.teamName === playerState.teamName && message.newManagerId === playerState.playerId) {
                        playerState.isManager = true;
                        updatePlayerGameInfo();
                        alert('You are now the team manager!');
                    }
                    break;

                case 'SCORE_CONFIRMED':
                    alert(`Score submitted: ${message.score} points. Team total: ${message.totalScore}`);
                    break;

                case 'REVEAL_FINAL_SCORES':
                    // Find our team in standings
                    const ourTeam = message.standings.find(team => team.name === playerState.teamName);
                    if (ourTeam) {
                        let placement = message.standings.indexOf(ourTeam) + 1;
                        let isTied = false;
                        
                        // Check for ties - find teams with same score
                        const teamsWithSameScore = message.standings.filter(team => team.score === ourTeam.score);
                        if (teamsWithSameScore.length > 1) {
                            // Find the best placement among tied teams
                            placement = Math.min(...teamsWithSameScore.map(team => message.standings.indexOf(team) + 1));
                            isTied = true;
                        }
                        
                        showFinalResults(placement, ourTeam.score, isTied);
                    }
                    break;

                case 'HOST_DISCONNECTED':
                    alert('Host has disconnected. The game may end soon.');
                    break;

                case 'ERROR':
                    console.log('Server error:', message.message);
                    // Only show alert for important errors
                    if (message.message.includes('not found') || message.message.includes('Game') || message.message.includes('Team')) {
                        alert('Error: ' + message.message);
                    }
                    
                    // If game not found, return to code entry
                    if (message.message.includes('not found')) {
                        document.getElementById('playerSetup').classList.add('hidden');
                        document.getElementById('gameCodeEntry').classList.remove('hidden');
                        playerState.gameCode = '';
                    }
                    break;
            }
        }

        function goBackToTeamChoice() {
            // Show name input and team choice buttons again
            document.getElementById('playerName').classList.remove('hidden');
            document.getElementById('teamOptions').classList.remove('hidden');
            
            // Hide both team creation and joining forms
            document.getElementById('teamCreation').classList.add('hidden');
            document.getElementById('teamJoining').classList.add('hidden');
            
            // Clear any entered data
            document.getElementById('teamName').value = '';
            document.getElementById('teamSelect').innerHTML = '<option value="">Select a team to join</option>';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            createSparkles();
            initializeConnection();

            // Auto-format game code input
            document.getElementById('gameCodeInput').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length > 6) value = value.substr(0, 6);
                e.target.value = value;
            });
        });

        // Handle page visibility change for reconnection
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!ws || ws.readyState === WebSocket.CLOSED)) {
                initializeConnection();
                // Rejoin game if we were in one
                if (playerState.gameCode && playerState.teamName) {
                    setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'REJOIN_GAME',
                                playerId: playerState.playerId,
                                playerName: playerState.name,
                                teamName: playerState.teamName,
                                gameCode: playerState.gameCode,
                                isManager: playerState.isManager
                            }));
                        }
                    }, 1000);
                }
            }
        });

        // Handle browser back/forward
        window.addEventListener('beforeunload', function(e) {
            if (playerState.gameCode && ws && ws.readyState === WebSocket.OPEN) {
                // Let server know we're leaving
                ws.send(JSON.stringify({
                    type: 'PLAYER_DISCONNECT',
                    playerId: playerState.playerId,
                    gameCode: playerState.gameCode
                }));
            }
        });
        
    </script>
    <div id="nameConflictModal" class="card hidden" style="position:fixed;left:50%;top:20%;transform:translateX(-50%);max-width:480px;z-index:9999;">
  <div id="conflictText" style="margin-bottom:12px;font-weight:bold;"></div>
  <div class="btn-row">
    <button class="btn btn-success" id="claimNameBtn">‚úÖ That's me</button>
    <button class="btn btn-warning" id="renameBtn">‚úèÔ∏è Enter different name</button>
  </div>
</div>

</body>
</html>
